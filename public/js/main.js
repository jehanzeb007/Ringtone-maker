function initUploader(){var settings={runtimes:"html5,flash",browse_button:"pick-files",container:"upload-buttons-wrapper",url:origin+"upload",flash_swf_url:origin+"common/js/plupload2/js/Moxie.swf",filters:{prevent_duplicates:!0,max_file_size:sizeLimit},multipart:!0,dragdrop:!0,drop_element:"container"};uploader=new plupload.Uploader(settings),uploader.bind("Init",function(up,params){"html5"==params.runtime&&$("#carousel").append('<div id="plupload_drop">'+text.js_dropfiles+"</div>"),up.bind("BeforeUpload",function(a,b){a.settings.multipart_params?$.extend(a.settings.multipart_params,{id:b.id}):a.settings.multipart_params={id:b.id}}),up.bind("FilesAdded",function(a,b){for(var c=0;a.files.length>maxQueue;)a.removeFile(a.files[maxQueue]),c++;$("#plupload_drop").hide(0);var d=b.length-c;"object"==typeof uploadCarousel?$.each(b,function(a,b){d<=0||1!=b.status||(uploadCarousel.xCarousel("addItem",fileBlock(b)),d--)}):($.each(b,function(a,b){d<=0||1!=b.status||($("#filelist").append(fileBlock(b)),d--)}),uploadCarousel=$("#carousel").xCarousel({btnPrev:"#carousel-prev",btnNext:"#carousel-next",visible:visibleFiles,updateButtons:updateButtons})),updateList(),a.refresh(),a.start()}),up.bind("UploadProgress",function(a,b){$("#"+b.id+" div.plupload_file_status").html(b.percent+"% "+text.js_of+" "+plupload.formatSize(b.size).toUpperCase()),$("#"+b.id+" div.plupload_file_progress_bar").css("width",b.percent+"%"),handleStatus(b),settings.multiple_queues&&a.total.uploaded+a.total.failed==a.files.length&&$(".plupload_start").addClass("plupload_disabled")}),up.bind("Error",function(a,b){var d,c=b.file;c&&(d=b.message,b.details&&(d+=" ("+b.details+")"),b.code==plupload.FILE_SIZE_ERROR&&x_prettyError(text.js_toobig+": "+c.name),b.code==plupload.FILE_EXTENSION_ERROR&&x_prettyError(text.js_wrongtype+": "+supportedFormats+"."),c.hint=d,$("#"+c.id).attr("class","plupload_failed").find("a").css("display","block").attr("title",d)),a.refresh()}),up.bind("FileUploaded",function(up,file,response){var res=eval(jQuery.parseJSON(response.response));null!==res&&(res.audio?($("#"+file.id+" .plupload_file_status").remove(),$("#"+file.id+" .plupload_file_progress_bar").remove(),$("#"+file.id+" .plupload_thumb").css({"background-image":"url("+res.audio.thumb_url+")","background-repeat":"no-repeat","background-position":"center",cursor:"pointer","background-color":"transparent"}),$("#"+file.id+" .plupload_thumb").click(function(a){initPanel(file.id),a.preventDefault()}),$("#"+file.id+" .plupload_thumb").mouseenter(function(){$("#"+file.id+" .plupload_file_wrapper").addClass("ui-state-active")}).mouseleave(function(){$("#"+file.id+" .plupload_file_wrapper").removeClass("ui-state-active")}),fileID||initPanel(file.id)):up.trigger("Error",{file:file,message:res.error.message||text.js_error}))}),up.bind("UploadFile",function(a,b){$("#"+b.id).addClass("plupload_current_file")}),up.bind("StateChanged",function(){up.state===plupload.STARTED?$("li.plupload_delete a").hide("fade"):updateList()}),up.bind("QueueChanged",updateList)}),uploader.init()}function initPanel(a){allowActions&&(clearPreview(),$(".plupload_filelist li .plupload_file_wrapper").removeClass("ui-button-inverse"),$("#"+a+" .plupload_file_wrapper").addClass("ui-button-inverse"),$("#content-wrapper").show(0),contentProgress("start",text.status_processing),fileID=a,getPanel(fileID))}function initGUI(a){$("#player-spinner-min").spinner({step:.1,numberFormat:"n",min:0,max:songDuration,create:function(a,b){spinner.min=$("#player-spinner-min")},change:function(a,b){if("object"==typeof a.handleObj&&"blur"==a.handleObj.type&&$(this).spinner("isValid")){var c=round($(this).spinner("value"));c!=range.min&&(slider.range.slider("values",[c,range.max]),slideRange([c,range.max],1),spinner.max.spinner("option","min",c))}},spin:function(a,b){slider.range.slider("values",[b.value,range.max]),slideRange([b.value,range.max],1),spinner.max.spinner("option","min",b.value),setTimeout(function(){spinner.min.blur()},1e3)}}),$("#player-spinner-max").spinner({step:.1,numberFormat:"n",min:0,max:songDuration,create:function(a,b){spinner.max=$("#player-spinner-max")},change:function(a,b){if("object"==typeof a.handleObj&&"blur"==a.handleObj.type&&$(this).spinner("isValid")){var c=round($(this).spinner("value"));c!=range.max&&(slider.range.slider("values",[range.min,c]),slideRange([range.min,c],1),spinner.min.spinner("option","max",c))}},spin:function(a,b){slider.range.slider("values",[range.min,b.value]),slideRange([range.min,b.value],1),spinner.min.spinner("option","max",b.value),setTimeout(function(){spinner.max.blur()},1e3)}}),$("#player-spinner-min, #player-spinner-max").keypress(function(a){9!=a.keyCode&&13!=a.keyCode||(a.preventDefault(),$(this).blur())}),$("#player-play").button({text:!1,icons:{primary:"ui-icon-play"}}).click(function(){bMode.play?($(this).button("option",{icons:{primary:"ui-icon-pause"}}),bMode.play=0,$(this).parent().parent().find(".text").html(text.panel_pause),pos>=range.max?player.jPlayer("play",range.min):player.jPlayer("play")):($(this).button("option",{icons:{primary:"ui-icon-play"}}),bMode.play=1,$(this).parent().parent().find(".text").html(text.panel_play),player.jPlayer("pause")),$(this).blur()}),$("#player-stop").button({text:!1,icons:{primary:"ui-icon-stop"}}).click(function(){movePlayHead(player,range.min,"pause"),$(this).blur(),$("#player-play").button("option",{icons:{primary:"ui-icon-play"}}),$("#player-play").parent().parent().find(".text").html(text.panel_play),bMode.play=1}),$("#player-repeat").button({text:!1,icons:{primary:"ui-icon-refresh"},create:function(){$("label[for='player-repeat']").hasClass("ui-state-active")&&(bMode.repeat=1)}}).click(function(){bMode.repeat?bMode.repeat=0:bMode.repeat=1,$(this).blur()}),$("#player-volume").slider({animate:!1,max:1,range:"min",step:.01,value:$.jPlayer.prototype.options.volume,slide:function(a,b){player.jPlayer("option","muted",!1),player.jPlayer("option","volume",b.value)},create:function(a,b){slider.volume=$("#player-volume")},stop:function(a,b){slider.volume.find(".ui-slider-handle").blur()}}),$("#player-progress").slider({animate:!1,max:songDuration,range:"min",step:.1,value:0,slide:function(a,b){var c=0,d=round(b.value);if(b.value<range.min?(c=1,d=range.min):b.value>range.max&&(c=1,d=range.max),movePlayHead(player,d,"noslide"),c)return!1},create:function(a,b){slider.progress=$("#player-progress")},start:function(){(wasPaused=playerData.status.paused)||player.jPlayer("pause")},stop:function(){wasPaused||player.jPlayer("play"),slider.progress.find(".ui-slider-handle").blur()}}),$("#player-range").slider({animate:!1,max:songDuration,range:!0,step:.1,values:[0,songDuration],slide:function(a,b){slideRange(b.values)},create:function(a,b){slider.range=$("#player-range"),spinner.min.spinner("value",0),spinner.max.spinner("value",songDuration)},start:function(){(wasPaused=playerData.status.paused)||player.jPlayer("pause")},stop:function(){wasPaused||player.jPlayer("play"),slider.range.find(".ui-slider-handle").blur()}}),$("#player-format").buttonset(),$("#player-cut").button({icons:{primary:"ui-icon-scissors"},disabled:a}).click(function(){if($(this).blur().trigger("mouseout"),$("#player-stop").trigger("click"),0==range.min&&range.max==songDuration||range.min==range.max)return void x_prettyError(text.js_range);contentProgress("start",text.status_cutting),getSection()})}function initPlayer(a,b){player=$("#player");var c={preload:"auto",ready:function(b){clearTimeout(ito),canPlay=0,contentProgress("status",text.status_loading),b.jPlayer.status.noVolume&&$("#player-gui").addClass("no-volume"),$(this).jPlayer("setMedia",{oga:a.ogg_url,mp3:a.mp3_url})},timeupdate:function(a){if("number"==typeof range.min&&"number"==typeof range.max){var b=round(a.jPlayer.status.currentTime);if(a.jPlayer.status.currentTime>range.max)return pos=range.min,void(1==bMode.repeat?movePlayHead(player,pos):(player.jPlayer("pause"),$("#player-stop").trigger("click")));a.jPlayer.status.currentTime>range.max-.33&&(clearTimeout(sto),sto=setTimeout(function(){pos=range.min,1==bMode.repeat?movePlayHead(player,pos):(player.jPlayer("pause"),$("#player-stop").trigger("click"))},Math.floor(1e3*(range.max-a.jPlayer.status.currentTime))-10)),b===pos||playerData.status.paused||slider.progress.slider("value",b),pos=b}},canplaythrough:function(c){initAudio(c,a,b)},ended:function(a){$("#player-stop").trigger("click")},supplied:"oga, mp3",cssSelectorAncestor:"#player-container",wmode:"window",solution:defaultSolution,swfPath:"/common/swf"};ito=setTimeout(function(){if(defaultSolution="html","object"==typeof player)try{player.jPlayer("destroy")}catch(a){}c.solution=defaultSolution,player.jPlayer(c),playerData=player.data("jPlayer")},2e3),player.jPlayer(c),playerData=player.data("jPlayer")}function initAudio(a,b,c){1!=canPlay&&(canPlay=1,a.jPlayer.status.duration>0?songDuration=round(a.jPlayer.status.duration):(a.jPlayer.status.format.oga&&(songDuration=round(b.ogg_duration)),a.jPlayer.status.format.mp3&&(songDuration=round(b.mp3_duration))),range.min=0,range.max=songDuration,initGUI(c),drawRuler(),contentProgress("stop"))}function getPanel(){x_ajax({req:{url:"drawUpload/"+fileID,type:"GET",dataType:"json"},onData:function(a){songDuration=0,pos=0,wasPaused=0,slider={progress:null,range:null,volume:null},range={min:null,max:null},bMode={play:1,repeat:0},spinner={min:null,max:null},$("#content").html(a.html),initPlayer(a.audio)},onError:function(){clearPreview()},onFail:function(){clearPreview()},attempts:10})}function getSample(){x_ajax({req:{url:url+"/sample",type:"GET",dataType:"json"},onData:function(a){songDuration=0,pos=0,wasPaused=0,slider={progress:null,range:null,volume:null},range={min:null,max:null},bMode={play:1,repeat:0},spinner={min:null,max:null},$("#content").html(a.html),initPlayer(a.audio,!0),$("#content-wrapper").show(0)},onError:function(){contentProgress("stop"),clearPreview()},onFail:function(){contentProgress("stop"),clearPreview()},silent:1,attempts:3})}function getSection(){x_ajax({req:{url:"cut/"+fileID,type:"GET",data:{format:$("input[name=format]:checked").val(),start:range.min,end:range.max},dataType:"json"},onData:function(a){contentProgress("stop");var b=a.audio;1==dlMode?downloadURI("download/"+b.sid+"/"+b.fid+"/"+b.result+"?rnd="+Math.random(),b.result):($(".ui-dialog").remove(),$("<div />").html('<iframe id="resultPlayer" src="result/'+fileID+"?rnd="+Math.random()+'" frameborder="0" marginwidth="0" marginheight="0" width="100%" height="100%" scrolling="no" style="overflow: hidden" allowfullscreen></iframe>').dialog({title:text.result_title,modal:!0,resizable:!1,draggable:!1,width:750,height:$("body").hasClass("adb")?220:300,dialogClass:"result-window",position:{my:"center",at:"center",of:window},beforeClose:function(){try{document.getElementById("resultPlayer").contentWindow.onClose()}catch(a){}}}))},onError:function(){contentProgress("stop")},onFail:function(){contentProgress("stop")},attempts:10})}function updateButtons(){$("#carousel-prev, #carousel-next, #pick-files, #reset-all").each(function(){if($(this).hasClass("disabled")||$(this).hasClass("plupload_disabled"))try{$(this).button("disable")}finally{}else try{$(this).button("enable")}finally{}}),"object"==typeof uploader&&($("#pick-files").hasClass("plupload_disabled")?uploader.trigger("DisableBrowse",!0):uploader.trigger("DisableBrowse",!1))}function prettyPolicy(){$(".pretty-policy").remove(),$.get("/policy",function(a){$("<div />",{class:"pretty-policy"}).html(a).dialog({width:"80%",modal:!1,resizable:!1,title:"Privacy Policy",position:{my:"center",at:"center",of:window}})})}function updateCarousel(){var a=$("#carousel-wrapper").width()-54;$("#container").css({width:a+"px",left:"27px"}),Math.floor(a/200)!==visibleFiles&&(visibleFiles=Math.floor(a/200),"object"==typeof uploadCarousel&&uploadCarousel.xCarousel("setVisible",visibleFiles)),winWidth=$(window).width()}function updateDialog(){$(".ui-dialog-content").dialog("option","position",{my:"center",at:"center",of:window})}function fileBlock(a){var b;return b=a.name.length>25?a.name.slice(0,18)+"&hellip;"+a.name.slice("-5"):a.name,'<li id="'+a.id+'" class=" plupload_file"><div class="plupload_file_wrapper ui-widget ui-state-default ui-corner-all"><div class="plupload_file_action"><div class="plupload_file_icon ui-icon"></div></div><div class="plupload_file_name"><span title="'+a.name+'">'+b+'</span></div><div class="plupload_thumb_wrapper"><div class="plupload_file_status">'+a.percent+"% of "+plupload.formatSize(a.size).toUpperCase()+'</div><div class="plupload_file_progress_bar" style="width:'+a.percent+'%;"></div><div class="plupload_thumb"></div></div></div></li>'}function handleStatus(a,b){var c,d;a.status==plupload.DONE&&(c="plupload_done",d="ui-icon-circle-close"),a.status==plupload.FAILED&&(c="plupload_failed",d="ui-icon-alert"),a.status==plupload.QUEUED&&(c="plupload_delete",d="ui-icon-circle-minus"),a.status==plupload.UPLOADING&&(c="plupload_uploading",d="ui-icon-circle-arrow-n"),$("#"+a.id).removeClass("plupload_done plupload_failed plupload_delete plupload_uploading").addClass(c),$("#"+a.id+" .plupload_file_icon").removeClass("ui-icon-circle-close ui-icon-alert ui-icon-circle-minus ui-icon-circle-arrow-n").addClass(d),a.hint&&$("#"+a.id+" .plupload_file_icon").attr("title",a.hint)}function updateList(){$.each(uploader.files,function(a,b){handleStatus(b),$("#"+b.id+".plupload_delete div.plupload_file_icon").click(function(a){$("#"+b.id+" .plupload_file_wrapper").hasClass("ui-button-inverse")&&clearPreview(1),uploadCarousel.xCarousel("removeItem","#"+b.id),uploader.removeFile(b),a.preventDefault()})}),$("#pick-files").toggleClass("plupload_disabled",uploader.files.length>=maxQueue),$("#reset-all").toggleClass("plupload_disabled",uploader.files.length<=0),0==uploader.files.length&&$("#plupload_drop").show(0),updateButtons()}function clearPreview(a){if(1!=clearingPreview){if(clearingPreview=1,"object"==typeof player)try{player.jPlayer("destroy")}catch(a){}player=null,a&&($("#content-wrapper").hide(0,function(){$("#content").html("")}),fileID=void 0),clearingPreview=0,progress=0}}function updateSize(){winWidth!==$(window).width()&&(winWidth=$(window).width(),updateCarousel(),clearTimeout(resizeTimeout),resizeTimeout=setTimeout(function(){updateCarousel(),updateDialog()},100))}function slideRange(a,b){var c=round(playerData.status.currentTime);a[0]=round(a[0]),a[1]=round(a[1]),a[0]!=range.min||c<a[0]?movePlayHead(player,a[0]):c>=a[1]&&(1==bMode.repeat?movePlayHead(player,range.min):$("#player-stop").trigger("click")),range.min=a[0],range.max=a[1],b||setTimeout(function(){spinner.min.spinner("value",range.min).spinner("option","max",range.max),spinner.max.spinner("value",range.max).spinner("option","min",range.min)},0),range.min==range.max&&$("#player-stop").trigger("click")}function movePlayHead(a,b,c){a.data("jPlayer").status.paused||"pause"==c?a.jPlayer("pause",b):a.jPlayer("play",b),"noslide"!=c&&slider.progress.slider("value",b)}function round(a){return Math.round(10*a)/10}function drawRuler(){var d,a=Math.floor(songDuration/10),b=100/(songDuration/10),c=$('<ul class="ruler">');for(d=0;d<a;d++)c.append($("<li>"));$("#player-range").append(c).append($('<div class="ruler-line">')),$(".ruler li").css("width",b+"%")}function contentProgress(a,b){var c={lines:13,length:13,width:4,radius:13,corners:1,rotate:0,direction:1,color:"#8D8D8D",speed:1,trail:60,shadow:!1,hwaccel:!0,className:"spinner",zIndex:2e9,top:"35%",left:"50%"};"start"==a?($("#content-progress").fadeIn(100),"object"==typeof progressor?progressor.spin(document.getElementById("content-progress")):progressor=new Spinner(c).spin(document.getElementById("content-progress"))):"stop"==a&&$("#content-progress").fadeOut(100,function(){"object"==typeof progressor&&progressor.stop(),$("#content-progress-status").html("")}),"start"!=a&&"status"!=a||$("#content-progress-status").html(b)}function downloadURI(a,b){if(HTMLElement.prototype.click){var c=document.createElement("a");c.download=b,c.href=a,c.style.display="none",document.body.appendChild(c),c.click(),setTimeout(function(){c.remove()},500)}else window.location.href=a}var pid,allowActions=1,flash=0,attempts,allowProcessing=0,progressor,defaultSolution="html",sessionID=randomString(),fileID,uploadCarousel,maxQueue=20,uploader,progress=0,resizeTimeout,winWidth,visibleFiles=4,zf=1,clearingPreview=0,ito,sto,canPlay,songDuration,player,playerData,pos,slider,tmo,wasPaused,range,bMode,spinner,origin=window.location.href;$(document).ready(function(){updateSize(),$(window).bind("resize",updateSize),$(window).bind("orientationchange",updateSize),$("#pick-files").button({icons:{primary:"ui-icon-folder-open"}}),$("#reset-all").button({icons:{primary:"ui-icon-close"}}),$("#carousel-prev").button({icons:{primary:"ui-icon-triangle-1-w"},text:!1}),$("#carousel-next").button({icons:{primary:"ui-icon-triangle-1-e"},text:!1}),initUploader(),$("#reset-all").click(function(a){this.blur(),$(this).trigger("mouseout"),clearPreview(1);for(var b=0;b<uploader.files.length;b++)uploadCarousel.xCarousel("removeItem","#"+uploader.files[b].id);uploader.splice(),uploader.refresh(),sessionID=randomString(),uploader.settings.url=origin+"upload",a.preventDefault()}),updateButtons(),$.fx.speeds._default=100,contentProgress("start",text.status_loading),getSample()});